---
phase: 02-agent-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agent-spawn.js
  - workflows/gsd/gsd-spawn-agents.md
autonomous: true

must_haves:
  truths:
    - "Main context can spawn multiple cline processes in background"
    - "Each spawned agent runs with -y flag for headless mode"
    - "PIDs are captured for each spawned agent"
    - "Spawning works on Mac, Linux, and Windows"
  artifacts:
    - path: "src/agent-spawn.js"
      provides: "Cross-platform agent spawning functions"
      exports: ["spawnAgent", "spawnAgents", "waitForAgents"]
    - path: "workflows/gsd/gsd-spawn-agents.md"
      provides: "Workflow documentation for agent spawning pattern"
      contains: "cline -y"
  key_links:
    - from: "src/agent-spawn.js"
      to: "child_process"
      via: "spawn function"
      pattern: "spawn\\("
    - from: "workflows/gsd/gsd-spawn-agents.md"
      to: "src/agent-spawn.js"
      via: "documents the pattern"
      pattern: "spawnAgent"
---

<objective>
Create cross-platform agent spawning infrastructure for Cline-GSD.

Purpose: Enable the main Cline context to spawn parallel CLI subagents that can perform read-only research and mapping tasks. This is the foundation for all multi-agent workflows in GSD.

Output: A Node.js module with spawn/wait functions and a workflow document showing the pattern.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-infrastructure/02-CONTEXT.md
@.planning/phases/02-agent-infrastructure/02-RESEARCH.md
@src/platform.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent spawning module</name>
  <files>src/agent-spawn.js</files>
  <action>
Create a Node.js ESM module that provides cross-platform agent spawning:

1. `spawnAgent(prompt, options)` - Spawns a single Cline agent in background
   - Uses `child_process.spawn` with `cline -y "prompt"`
   - Returns `{ pid, process }` object
   - Options: `{ outputFile, timeout, cwd }`
   - On Windows: use `shell: true` for proper execution
   - On Unix: use detached mode with stdio handling

2. `spawnAgents(agents)` - Spawns multiple agents in parallel
   - Takes array of `{ prompt, outputFile }` objects
   - Returns array of `{ pid, process, outputFile }` objects
   - All agents start immediately (parallel, not sequential)

3. `waitForAgents(agents, options)` - Waits for all agents to complete
   - Takes array from spawnAgents
   - Returns array of `{ pid, exitCode, outputFile, success }` objects
   - Options: `{ timeout }` - optional timeout in ms
   - Tracks failures (non-zero exit codes)

Use the platform detection from src/platform.js. Import path:
```javascript
import { getPlatform } from './platform.js';
```

Cross-platform considerations:
- Windows: `shell: true` required for command execution
- Unix: Use `detached: true` for proper background behavior
- All platforms: Capture stdout/stderr for debugging

Do NOT use complex process management libraries. Shell primitives via child_process are sufficient per RESEARCH.md.
  </action>
  <verify>
Create a simple test script and run:
```bash
node -e "import('./src/agent-spawn.js').then(m => console.log('Exports:', Object.keys(m)))"
```
Should output: `Exports: [ 'spawnAgent', 'spawnAgents', 'waitForAgents' ]`
  </verify>
  <done>Module exports spawnAgent, spawnAgents, and waitForAgents functions with cross-platform support</done>
</task>

<task type="auto">
  <name>Task 2: Create spawn-agents workflow documentation</name>
  <files>workflows/gsd/gsd-spawn-agents.md</files>
  <action>
Create a Cline workflow that documents the agent spawning pattern for GSD workflows to reference.

Frontmatter:
```yaml
---
description: Documents the parallel agent spawning pattern used by GSD workflows
---
```

Content should include:

1. **Overview** - Explain that GSD uses parallel CLI subagents for research/mapping
2. **Spawning Pattern** - Show the bash pattern:
   ```bash
   cline -y "Your prompt here" &
   PID1=$!
   ```
3. **File Output Convention** - Document that agents write to .planning/ subdirectories:
   - `.planning/codebase/` for mapping agents
   - `.planning/research/` for research agents
   - `.planning/phases/XX-name/` for phase-specific work
4. **Waiting Pattern** - Show how to wait and collect:
   ```bash
   wait $PID1
   EXIT_CODE=$?
   ```
5. **Cross-Platform Note** - Mention Windows uses PowerShell equivalent
6. **Example** - Full example spawning 3 parallel mapping agents

This workflow is DOCUMENTATION for other workflows to reference, not an executable workflow itself. It establishes the pattern that gsd-map-codebase and gsd-research will use.
  </action>
  <verify>
```bash
test -f workflows/gsd/gsd-spawn-agents.md && grep -q "cline -y" workflows/gsd/gsd-spawn-agents.md && echo "OK"
```
  </verify>
  <done>Workflow documentation exists and contains the spawning pattern with -y flag</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Module loads without errors:
   ```bash
   node -e "import('./src/agent-spawn.js').then(() => console.log('Module loads OK'))"
   ```

2. Workflow file exists with correct content:
   ```bash
   cat workflows/gsd/gsd-spawn-agents.md | head -20
   ```

3. Platform function is available (dependency check):
   ```bash
   node -e "import('./src/platform.js').then(m => console.log('Platform:', m.getPlatform()))"
   ```
</verification>

<success_criteria>
- src/agent-spawn.js exports spawnAgent, spawnAgents, waitForAgents
- Functions handle cross-platform differences (Windows shell: true, Unix detached)
- workflows/gsd/gsd-spawn-agents.md documents the pattern with bash examples
- No new dependencies added (uses child_process from Node.js)
- Module integrates with existing platform.js
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-infrastructure/02-01-SUMMARY.md`
</output>
