---
phase: 02-agent-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/agent-collect.js
  - workflows/gsd/gsd-collect-outputs.md
autonomous: true

must_haves:
  truths:
    - "Orchestrator can verify agent output files exist"
    - "Orchestrator can read and report on collected outputs"
    - "Missing or empty outputs are detected and reported"
    - "Collection works with any .planning/ subdirectory"
  artifacts:
    - path: "src/agent-collect.js"
      provides: "Output verification and collection functions"
      exports: ["verifyOutputs", "collectOutputs", "reportResults"]
    - path: "workflows/gsd/gsd-collect-outputs.md"
      provides: "Workflow documentation for output collection pattern"
      contains: "verifyOutputs"
  key_links:
    - from: "src/agent-collect.js"
      to: "fs/promises"
      via: "file operations"
      pattern: "readFile|stat|access"
    - from: "src/agent-collect.js"
      to: "src/agent-spawn.js"
      via: "used after waitForAgents"
      pattern: "outputFile"
---

<objective>
Create output verification and collection infrastructure for agent results.

Purpose: After spawned agents complete, the orchestrator needs to verify outputs exist, collect them, and synthesize results. This completes the agent infrastructure by providing the "collect" half of "spawn and collect."

Output: A Node.js module with verification/collection functions and a workflow document showing the pattern.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-infrastructure/02-CONTEXT.md
@.planning/phases/02-agent-infrastructure/02-RESEARCH.md
@.planning/phases/02-agent-infrastructure/02-01-SUMMARY.md
@src/agent-spawn.js
@src/output.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent output collection module</name>
  <files>src/agent-collect.js</files>
  <action>
Create a Node.js ESM module that provides output verification and collection:

1. `verifyOutputs(files)` - Verifies expected output files exist
   - Takes array of file paths (strings)
   - Returns array of `{ path, exists, lines, bytes }` objects
   - Uses fs/promises for async file operations
   - Counts lines and bytes for existing files
   - Returns `{ exists: false, lines: 0, bytes: 0 }` for missing files

2. `collectOutputs(files)` - Reads content from output files
   - Takes array of file paths
   - Returns array of `{ path, content, error }` objects
   - content is null if file doesn't exist or can't be read
   - error contains the error message if read failed

3. `reportResults(verifications)` - Generates a summary report
   - Takes array from verifyOutputs
   - Returns object: `{ total, found, missing, report }`
   - report is a formatted string suitable for display:
     ```
     Agent Output Summary:
     - .planning/codebase/STACK.md: OK (45 lines)
     - .planning/codebase/ARCHITECTURE.md: MISSING
     Found: 1/2 outputs
     ```

Import output helpers for colored console output:
```javascript
import { success, error, warn, info } from './output.js';
```

All functions should be async. Handle file system errors gracefully (return error info, don't throw).
  </action>
  <verify>
```bash
node -e "import('./src/agent-collect.js').then(m => console.log('Exports:', Object.keys(m)))"
```
Should output: `Exports: [ 'verifyOutputs', 'collectOutputs', 'reportResults' ]`
  </verify>
  <done>Module exports verifyOutputs, collectOutputs, and reportResults functions</done>
</task>

<task type="auto">
  <name>Task 2: Create collect-outputs workflow documentation</name>
  <files>workflows/gsd/gsd-collect-outputs.md</files>
  <action>
Create a Cline workflow that documents the output collection pattern.

Frontmatter:
```yaml
---
description: Documents how to verify and collect agent outputs after spawning
---
```

Content should include:

1. **Overview** - After agents complete, verify outputs and collect for synthesis
2. **Verification Pattern** - Check files exist before reading:
   ```bash
   for file in .planning/codebase/*.md; do
     if [ -f "$file" ]; then
       lines=$(wc -l < "$file")
       echo "OK: $file ($lines lines)"
     else
       echo "MISSING: $file"
     fi
   done
   ```
3. **Expected Output Locations** - Document the .planning/ structure:
   ```
   .planning/
   ├── codebase/     # STACK.md, ARCHITECTURE.md, etc.
   ├── research/     # ECOSYSTEM.md, FEASIBILITY.md
   └── phases/XX-name/  # Phase-specific research
   ```
4. **Error Handling** - What to do when outputs are missing:
   - Check agent exit codes from waitForAgents
   - Re-run failed agents or proceed with partial results
5. **Synthesis Pattern** - How orchestrator uses collected outputs

This documents the pattern that gsd-map-codebase and gsd-research workflows will use after spawning agents.
  </action>
  <verify>
```bash
test -f workflows/gsd/gsd-collect-outputs.md && grep -q "verifyOutputs\|\.planning/" workflows/gsd/gsd-collect-outputs.md && echo "OK"
```
  </verify>
  <done>Workflow documentation exists and contains verification patterns and .planning/ structure</done>
</task>

<task type="auto">
  <name>Task 3: Create integration test script</name>
  <files>scripts/test-agent-infra.js</files>
  <action>
Create a test script that validates the agent infrastructure works end-to-end.

This script should:

1. Import both modules:
   ```javascript
   import { spawnAgent, spawnAgents, waitForAgents } from '../src/agent-spawn.js';
   import { verifyOutputs, collectOutputs, reportResults } from '../src/agent-collect.js';
   ```

2. Create a mock test that:
   - Creates a test output directory: `.planning/test/`
   - Spawns a simple agent that writes to `.planning/test/TEST.md`
   - The agent prompt: "Write 'Test output from agent' to .planning/test/TEST.md and confirm completion"
   - Waits for agent to complete
   - Verifies the output file exists
   - Collects and displays the content
   - Cleans up test directory

3. Output format:
   ```
   Agent Infrastructure Test
   ========================
   1. Spawning test agent...
   2. Waiting for completion...
   3. Verifying outputs...
   4. Collecting content...
   5. Cleanup...

   Result: PASS/FAIL
   ```

Make the script executable and add to package.json scripts:
```json
"test:agents": "node scripts/test-agent-infra.js"
```

NOTE: This test requires Cline CLI to be installed. If not available, the script should skip with a warning (don't fail the build).
  </action>
  <verify>
```bash
test -f scripts/test-agent-infra.js && node -e "import('./scripts/test-agent-infra.js')" 2>&1 | head -5
```
Script should either run or warn about missing Cline CLI.
  </verify>
  <done>Integration test script exists and validates spawn/collect workflow</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Collection module loads:
   ```bash
   node -e "import('./src/agent-collect.js').then(() => console.log('Module loads OK'))"
   ```

2. Both workflow docs exist:
   ```bash
   ls -la workflows/gsd/gsd-spawn-agents.md workflows/gsd/gsd-collect-outputs.md
   ```

3. Test script is in place:
   ```bash
   test -f scripts/test-agent-infra.js && echo "Test script exists"
   ```

4. Package.json has test script (if added):
   ```bash
   grep -q "test:agents" package.json && echo "npm script added"
   ```
</verification>

<success_criteria>
- src/agent-collect.js exports verifyOutputs, collectOutputs, reportResults
- Functions handle missing files gracefully (return info, don't throw)
- workflows/gsd/gsd-collect-outputs.md documents the collection pattern
- scripts/test-agent-infra.js validates end-to-end workflow
- Agent infrastructure is complete: spawn -> wait -> verify -> collect
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-infrastructure/02-02-SUMMARY.md`
</output>
