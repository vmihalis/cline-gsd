---
phase: 06-planning-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/discuss-phase.js
  - workflows/gsd/gsd-discuss-phase.md
autonomous: true

must_haves:
  truths:
    - "/gsd-discuss-phase N gathers context before planning"
    - "CONTEXT.md has exactly three sections: ## Decisions, ## Claude's Discretion, ## Deferred Ideas"
    - "Discuss-phase reads phase details from ROADMAP.md to guide the conversation"
  artifacts:
    - path: "src/discuss-phase.js"
      provides: "Phase detail extraction from ROADMAP.md and CONTEXT.md template structure"
      exports: ["getPhaseDetails", "getContextTemplateSections", "getOrCreatePhaseDir"]
    - path: "workflows/gsd/gsd-discuss-phase.md"
      provides: "Cline workflow for /gsd-discuss-phase interactive conversation"
      min_lines: 60
  key_links:
    - from: "workflows/gsd/gsd-discuss-phase.md"
      to: "src/discuss-phase.js"
      via: "node -e import"
      pattern: "import.*discuss-phase"
    - from: "src/discuss-phase.js"
      to: "src/state-read.js"
      via: "readRoadmap import"
      pattern: "import.*readRoadmap.*state-read"
    - from: "src/discuss-phase.js"
      to: "src/state-init.js"
      via: "ensurePhaseDir import"
      pattern: "import.*ensurePhaseDir.*state-init"
---

<objective>
Create the discuss-phase capability: a Node.js helper module and Cline workflow that enables interactive context gathering before planning.

Purpose: The discuss-phase workflow is the entry point for planning any phase. It guides a conversation between Cline and the user to produce a structured CONTEXT.md file that constrains all downstream planning (researcher, planner, checker agents all parse this file). Without discuss-phase, plans are created without user input, leading to misaligned implementations.

Output: `src/discuss-phase.js` module with phase detail extraction + CONTEXT.md template helpers, and `workflows/gsd/gsd-discuss-phase.md` workflow file.
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-planning-workflow/06-RESEARCH.md
@src/state-read.js
@src/state-init.js
@workflows/gsd/gsd-new-project.md
@workflows/gsd/gsd-map-codebase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/discuss-phase.js helper module</name>
  <files>src/discuss-phase.js</files>
  <action>
Create `src/discuss-phase.js` with three exported functions following the established error-return pattern (`{ success, data, error }`):

1. **`getPhaseDetails(planningDir, phaseNum)`** -- Read ROADMAP.md via `readRoadmap()`, extract the phase section using regex `### Phase N: Name`. Return `{ name, details, requirements, successCriteria }`. Parse the `**Requirements**:` line and `**Success Criteria**` block from the phase section. If phase not found, return `{ success: false, error: "Phase N not found in ROADMAP.md" }`.

2. **`getContextTemplateSections()`** -- Return the canonical CONTEXT.md section structure as a constant. This ensures both discuss-phase and plan-phase agree on the schema. The sections are exactly: `## Decisions`, `## Claude's Discretion`, `## Deferred Ideas`. Return `{ success: true, data: { sections: ['Decisions', "Claude's Discretion", 'Deferred Ideas'], template: string } }` where `template` is the full markdown skeleton with section headers and placeholder text.

3. **`getOrCreatePhaseDir(planningDir, phaseNum, phaseName)`** -- Thin wrapper around `ensurePhaseDir()` from state-init.js. Exists so the workflow only needs to import from one module.

Import from existing modules:
- `readRoadmap` from `./state-read.js`
- `ensurePhaseDir` from `./state-init.js`

Follow the exact patterns established in `map-codebase.js`:
- JSDoc comments on all functions
- Module-level doc comment listing exports
- Error-return pattern on all functions (try/catch, return `{ success, error }` on failure)
- `import path from 'node:path'` and `import { readFile } from 'node:fs/promises'` only if needed

The CONTEXT.md template returned by `getContextTemplateSections()` should look like:
```
# Phase {N}: {Name} - Context

**Discussed:** {date}

## Decisions
{user decisions listed as bullet points}

## Claude's Discretion
{areas where Claude can decide freely}

## Deferred Ideas
{ideas explicitly deferred to later phases}
```

The `{N}`, `{Name}`, `{date}`, and bullet content are filled in by the workflow (not this function). The function returns the skeleton with placeholder instructions.
  </action>
  <verify>
Run: `node -e "import { getPhaseDetails, getContextTemplateSections, getOrCreatePhaseDir } from './src/discuss-phase.js'; console.log('imports OK'); const t = getContextTemplateSections(); console.log('template sections:', t.data.sections); console.log(t.success ? 'PASS' : 'FAIL');"` -- should print imports OK, the three section names, and PASS.
  </verify>
  <done>
Module exports three functions. `getPhaseDetails` reads ROADMAP.md and extracts phase info. `getContextTemplateSections` returns the canonical 3-section CONTEXT.md schema. `getOrCreatePhaseDir` delegates to `ensurePhaseDir`. All functions use error-return pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflows/gsd/gsd-discuss-phase.md workflow</name>
  <files>workflows/gsd/gsd-discuss-phase.md</files>
  <action>
Create `workflows/gsd/gsd-discuss-phase.md` following the established workflow format from `gsd-new-project.md` and `gsd-map-codebase.md`.

Frontmatter:
```yaml
---
description: Gather context and decisions before planning a phase
---
```

Title: `# /gsd-discuss-phase.md - Discuss Phase Before Planning`

Opening paragraph: Explain this is an interactive discussion to gather decisions and context before creating plans. No agents are spawned -- this is a conversation.

Steps:

**Step 1: Parse phase number**
Extract phase number from user input. If not provided, ask "Which phase would you like to discuss?" and show the phase list from ROADMAP.md.

**Step 2: Load phase details**
```bash
node -e "
import { getPhaseDetails } from './src/discuss-phase.js';
const result = await getPhaseDetails('.planning', PHASE_NUM);
console.log(JSON.stringify(result, null, 2));
"
```
If failed, stop with error. If success, display the phase goal, requirements, and success criteria to give context for the discussion.

**Step 3: Check for existing CONTEXT.md**
```bash
ls .planning/phases/PADDED_PHASE-*/*-CONTEXT.md 2>/dev/null
```
If exists, inform user and offer to overwrite or keep existing. If keep, stop.

**Step 4: Ensure phase directory exists**
```bash
node -e "
import { getOrCreatePhaseDir } from './src/discuss-phase.js';
const result = await getOrCreatePhaseDir('.planning', PHASE_NUM, 'PHASE_NAME');
console.log(JSON.stringify(result));
"
```

**Step 5: Interactive discussion**
Present the phase goal and ask targeted questions:
- "What key decisions have you already made for this phase?" (technology choices, approach, constraints)
- "Are there areas where you'd like me to use my judgment?" (implementation details, naming, structure)
- "Is there anything explicitly out of scope for this phase?" (features to defer, ideas for later)

Follow energy -- dig into what the user emphasizes. Challenge vague answers. This typically takes 2-4 exchanges. When you have enough context, summarize and offer to proceed.

**Step 6: Write CONTEXT.md**
Using the gathered context, write the CONTEXT.md file with the Write tool. The file MUST use the exact section headers: `## Decisions`, `## Claude's Discretion`, `## Deferred Ideas`. File name: `{padded_phase}-CONTEXT.md` in the phase directory (e.g., `06-CONTEXT.md`).

**Step 7: Commit and suggest next step**
If commit_docs is true:
```bash
git add .planning/phases/PADDED_PHASE-*/*-CONTEXT.md && git commit -m "docs(PHASE): gather context via /gsd-discuss-phase"
```
Suggest: "Context gathered! Run `/gsd-plan-phase N` to create plans for this phase."

**Behavioral Guidelines section:**
- Be a thinking partner, not a questionnaire.
- Follow energy and challenge vagueness.
- This is purely interactive -- NO agents are spawned.
- CONTEXT.md section headers are sacred -- use exactly `## Decisions`, `## Claude's Discretion`, `## Deferred Ideas`.
- Keep the discussion focused on the specific phase, not the whole project.
- Never ask the user to create files -- always write them yourself.
  </action>
  <verify>
Verify the file exists and has correct structure: `head -5 workflows/gsd/gsd-discuss-phase.md` should show the YAML frontmatter with `description:` and the title heading. `grep -c "^## Step" workflows/gsd/gsd-discuss-phase.md` should return 7 (seven steps).
  </verify>
  <done>
Workflow file exists at `workflows/gsd/gsd-discuss-phase.md` with YAML frontmatter, 7 steps (parse phase, load details, check existing, ensure dir, interactive discussion, write CONTEXT.md, commit), and behavioral guidelines. References `src/discuss-phase.js` for helper functions. Uses the canonical CONTEXT.md section headers.
  </done>
</task>

</tasks>

<verification>
1. `node -e "import { getPhaseDetails, getContextTemplateSections, getOrCreatePhaseDir } from './src/discuss-phase.js'; console.log('OK');"` imports cleanly
2. `getContextTemplateSections()` returns exactly 3 sections: Decisions, Claude's Discretion, Deferred Ideas
3. `gsd-discuss-phase.md` exists with frontmatter, 7 steps, and references to discuss-phase.js
4. No new dependencies added (only uses existing modules)
</verification>

<success_criteria>
- `src/discuss-phase.js` exports 3 functions with error-return pattern
- `workflows/gsd/gsd-discuss-phase.md` is a complete Cline workflow with 7 steps
- CONTEXT.md schema uses the exact 3 section headers that agent definitions expect
- Workflow references the module (not inline logic) for phase detail extraction
</success_criteria>

<output>
After completion, create `.planning/phases/06-planning-workflow/06-01-SUMMARY.md`
</output>
