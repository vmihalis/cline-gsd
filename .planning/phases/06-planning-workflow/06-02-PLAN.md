---
phase: 06-planning-workflow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plan-phase.js
  - workflows/gsd/gsd-plan-phase.md
autonomous: true

must_haves:
  truths:
    - "/gsd:plan-phase N creates PLAN.md files with atomic tasks"
    - "Research agents run before planning when workflow.research is true in config"
    - "Plan checker validates plans when workflow.plan_check is true in config"
    - "Model orchestration logs advisory recommendations per agent step"
    - "Pipeline stops if planner agent fails to produce output"
  artifacts:
    - path: "src/plan-phase.js"
      provides: "Prompt builders for researcher/planner/checker agents and sequential pipeline runner"
      exports: ["buildResearchPrompt", "buildPlannerPrompt", "buildCheckerPrompt", "getExpectedPlanFiles", "runPlanningPipeline"]
    - path: "workflows/gsd/gsd-plan-phase.md"
      provides: "Cline workflow for /gsd-plan-phase orchestration"
      min_lines: 80
  key_links:
    - from: "workflows/gsd/gsd-plan-phase.md"
      to: "src/plan-phase.js"
      via: "node -e import"
      pattern: "import.*plan-phase"
    - from: "src/plan-phase.js"
      to: "src/agent-spawn.js"
      via: "spawnAgent import"
      pattern: "import.*spawnAgent.*agent-spawn"
    - from: "src/plan-phase.js"
      to: "src/agent-collect.js"
      via: "verifyOutputs import"
      pattern: "import.*verifyOutputs.*agent-collect"
    - from: "src/plan-phase.js"
      to: "src/state-read.js"
      via: "readPlanningConfig import"
      pattern: "import.*readPlanningConfig.*state-read"
---

<objective>
Create the plan-phase capability: a Node.js orchestration module and Cline workflow that runs a sequential agent pipeline (research -> plan -> check) to produce validated PLAN.md files.

Purpose: This is the core planning engine. It orchestrates three agents in sequence: a researcher (optional, config-gated), a planner (always), and a plan checker (optional, config-gated). Each agent builds on the previous agent's output. The result is validated PLAN.md files ready for execution. This directly satisfies requirements CMD-02, AGT-04, AGT-05, and AGT-06.

Output: `src/plan-phase.js` module with prompt builders + pipeline runner, and `workflows/gsd/gsd-plan-phase.md` workflow file.
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-planning-workflow/06-RESEARCH.md
@src/agent-spawn.js
@src/agent-collect.js
@src/state-read.js
@src/state-init.js
@src/map-codebase.js
@workflows/gsd/gsd-map-codebase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/plan-phase.js orchestration module</name>
  <files>src/plan-phase.js</files>
  <action>
Create `src/plan-phase.js` following the exact pattern established by `src/map-codebase.js`. This module handles prompt construction, pipeline orchestration, and output verification for the planning workflow.

Imports:
```javascript
import path from 'node:path';
import { readFile } from 'node:fs/promises';
import { spawnAgent, waitForAgents } from './agent-spawn.js';
import { verifyOutputs, reportResults } from './agent-collect.js';
import { readPlanningConfig } from './state-read.js';
import { ensurePhaseDir } from './state-init.js';
```

Module-level doc comment listing all exports.

**Exported functions:**

1. **`buildResearchPrompt(phaseNum, phaseName, phaseDetails, contextContent)`**
   - Builds the prompt for the researcher agent
   - Prompt references `agents/gsd-phase-researcher.md` (do NOT inline agent instructions)
   - Includes phase number, name, full details from ROADMAP.md
   - Includes CONTEXT.md content (if exists) as `<user_decisions>` tags, or notes "No CONTEXT.md exists"
   - Computes `outputFile` as `.planning/phases/{paddedPhase}-{slug}/{paddedPhase}-RESEARCH.md`
   - Returns `{ success: true, data: { prompt, outputFile } }`
   - Note: The slug portion of the path is unknown at build time. Use a glob-friendly approach: compute `{paddedPhase}-RESEARCH.md` as the filename, and accept `phaseDir` as a parameter instead of computing the full path. Signature should be `buildResearchPrompt(phaseNum, phaseName, phaseDetails, contextContent, phaseDir)` where `phaseDir` is the absolute path returned by `ensurePhaseDir`.

2. **`buildPlannerPrompt(phaseNum, phaseName, phaseDetails, contextContent, researchContent, phaseDir)`**
   - Builds the prompt for the planner agent
   - Prompt references `agents/gsd-planner.md`
   - Includes phase details and CONTEXT.md as `<user_decisions>` tags
   - If `researchContent` provided, includes it as `<research>` tags
   - outputFile: `{phaseDir}/{paddedPhase}-PLANS-DONE.md` (a marker file, since planner writes multiple PLAN.md files)
   - Returns `{ success: true, data: { prompt, outputFile } }`

3. **`buildCheckerPrompt(phaseNum, phaseName, contextContent, phaseDir)`**
   - Builds the prompt for the plan-checker agent
   - Prompt references `agents/gsd-plan-checker.md`
   - Includes CONTEXT.md as `<context_md>` tags
   - Instructs checker to read all PLAN.md files in the phase directory
   - outputFile: `{phaseDir}/{paddedPhase}-CHECK.md`
   - Returns `{ success: true, data: { prompt, outputFile } }`

4. **`getExpectedPlanFiles(phaseDir, paddedPhase)`**
   - Returns the marker/output files to verify for each pipeline stage
   - Returns `{ research: "{phaseDir}/{paddedPhase}-RESEARCH.md", plans: "{phaseDir}/{paddedPhase}-PLANS-DONE.md", check: "{phaseDir}/{paddedPhase}-CHECK.md" }`
   - This is analogous to `getExpectedOutputFiles` in map-codebase.js -- a single source of truth for output paths

5. **`runPlanningPipeline(projectRoot, phaseNum, phaseName, options = {})`**
   - Orchestrates the sequential pipeline: research -> plan -> check
   - `options`: `{ timeout, config, phaseDetails, contextContent }`
   - Default timeout: 600000 (10 minutes per agent)
   - Reads config via `readPlanningConfig()` if not provided in options
   - Ensures phase directory exists via `ensurePhaseDir()`

   Pipeline logic:
   ```
   Step 1: If config.workflow.research === true:
     - Log advisory: "Research step (model_profile suggests: cost-optimized model)"
     - Build research prompt, spawn agent, wait, verify output
     - If research fails: log warning, continue to planning (research is optional)
     - If succeeds: read RESEARCH.md content for planner context

   Step 2: Always run planner:
     - Log advisory: "Planning step (model_profile suggests: quality model)"
     - Build planner prompt (include research content if available)
     - Spawn agent, wait, verify marker file
     - If planner fails: return { success: false, error: "Planner agent did not produce output" }

   Step 3: If config.workflow.plan_check === true:
     - Log advisory: "Checking step (model_profile suggests: cost-optimized model)"
     - Build checker prompt, spawn agent, wait, verify output
     - If checker fails: log warning (non-fatal)
   ```

   Return: `{ success: true, data: { research: { ran, success, file }, planning: { ran: true, success, file }, checking: { ran, success, file } } }`

   The "Log advisory" lines about model_profile satisfy AGT-06 (model orchestration). The advisory notes which model tier would be ideal but does NOT enforce it -- Cline CLI uses globally configured model. This is intentional per the research findings.

Follow error-return pattern on ALL functions. Wrap `runPlanningPipeline` in try/catch.
  </action>
  <verify>
Run: `node -e "import { buildResearchPrompt, buildPlannerPrompt, buildCheckerPrompt, getExpectedPlanFiles, runPlanningPipeline } from './src/plan-phase.js'; console.log('imports OK'); const files = getExpectedPlanFiles('/tmp/test/06-planning', '06'); console.log('expected files:', JSON.stringify(files)); console.log('PASS');"` -- should print imports OK, the three expected file paths, and PASS.
  </verify>
  <done>
Module exports 5 functions: 3 prompt builders (research, planner, checker), 1 expected-files function, 1 pipeline runner. All use error-return pattern. Pipeline is sequential with config-gated stages. Model orchestration is advisory logging. Prompts reference agent definition files (not inline instructions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflows/gsd/gsd-plan-phase.md workflow</name>
  <files>workflows/gsd/gsd-plan-phase.md</files>
  <action>
Create `workflows/gsd/gsd-plan-phase.md` following established workflow patterns from `gsd-map-codebase.md`.

Frontmatter:
```yaml
---
description: Create validated plans for a phase with optional research and checking
---
```

Title: `# /gsd-plan-phase.md - Plan a Phase`

Opening paragraph: This workflow orchestrates the planning pipeline for a phase. It optionally runs a researcher agent, always runs a planner agent, and optionally runs a plan-checker agent. The pipeline is sequential -- each step depends on the previous output.

Steps:

**Step 1: Parse phase number**
Extract phase number from user input. If not provided, ask "Which phase would you like to plan?" Show phase list from ROADMAP.md with status.

**Step 2: Load phase details and config**
```bash
node -e "
import { getPhaseDetails } from './src/discuss-phase.js';
import { readPlanningConfig } from './src/state-read.js';
const [phase, config] = await Promise.all([
  getPhaseDetails('.planning', PHASE_NUM),
  readPlanningConfig('.planning')
]);
console.log(JSON.stringify({ phase: phase, config: config.data }, null, 2));
"
```
If phase not found, stop with error. Store phase details and config for subsequent steps.

**Step 3: Check for existing plans**
```bash
ls .planning/phases/PADDED_PHASE-*/*-PLAN.md 2>/dev/null
```
If plans exist, inform user and offer options:
1. **Re-plan** -- delete existing plans and re-run pipeline
2. **Skip** -- keep existing plans

If re-plan, delete existing PLAN.md files in the phase directory.

**Step 4: Check for CONTEXT.md**
```bash
ls .planning/phases/PADDED_PHASE-*/*-CONTEXT.md 2>/dev/null
```
If exists, read its content for use in agent prompts. If not, note: "No CONTEXT.md found. Consider running `/gsd-discuss-phase N` first for better plans. Continuing without context..."

**Step 5: Run planning pipeline**
Inform the user about what will happen:
- "Research agent: {enabled/disabled} (workflow.research in config)"
- "Plan checker: {enabled/disabled} (workflow.plan_check in config)"
- "This may take 5-15 minutes depending on phase complexity."

Run the pipeline:
```bash
node -e "
import { runPlanningPipeline } from './src/plan-phase.js';
const result = await runPlanningPipeline(
  process.cwd(),
  PHASE_NUM,
  'PHASE_NAME',
  {
    phaseDetails: 'PHASE_DETAILS',
    contextContent: CONTEXT_CONTENT_OR_NULL,
    timeout: 600000
  }
);
console.log(JSON.stringify(result, null, 2));
"
```

**Step 6: Verify results**
Check pipeline output:
- If `success: false`: report the error and suggest re-running.
- If `success: true`: report what was produced.

For each produced file, verify content:
```bash
for f in .planning/phases/PADDED_PHASE-*/*-PLAN.md; do
  lines=$(wc -l < "$f" 2>/dev/null || echo 0)
  name=$(basename "$f")
  echo "$name: $lines lines"
done
```

If checker ran, show its verdict summary.

**Step 7: Update state and commit**
Update STATE.md position to reflect planning is underway:
```bash
node -e "
import { updateStatePosition } from './src/state-write.js';
await updateStatePosition('.planning', {
  phaseNum: PHASE_NUM,
  totalPhases: TOTAL_PHASES,
  phaseName: 'PHASE_NAME',
  planNum: 0,
  totalPlans: PLAN_COUNT,
  status: 'Plans ready',
  lastActivity: 'DATE -- Created N plans via /gsd-plan-phase',
  completedPlans: COMPLETED_GLOBAL,
  totalPlansGlobal: TOTAL_GLOBAL
});
"
```

If commit_docs is true:
```bash
git add .planning/phases/PADDED_PHASE-*/ .planning/STATE.md && git commit -m "docs(PHASE): create phase plans via /gsd-plan-phase"
```

**Step 8: Present results and next steps**
Show summary:
- Pipeline stages run (research, planning, checking) with pass/fail for each
- Number of PLAN.md files created
- If checker had issues, summarize them

Suggest: "Plans are ready! Run `/gsd-progress` to see updated status, or start executing."

**Behavioral Guidelines:**
- Inform on spawn. Tell the user each agent is spawning and may take several minutes.
- Handle partial failures. If research fails, continue to planning. If checker fails, plans are still usable.
- Do not read PLAN.md contents in detail. Summarize count and line counts only.
- Keep it concise. The orchestration module does the heavy lifting.
- Never ask the user to run commands.
- Model orchestration is advisory. Log which model tier is recommended per step but do not enforce it.
  </action>
  <verify>
Verify the file exists and has correct structure: `head -5 workflows/gsd/gsd-plan-phase.md` should show YAML frontmatter. `grep -c "^## Step" workflows/gsd/gsd-plan-phase.md` should return 8 (eight steps).
  </verify>
  <done>
Workflow file exists at `workflows/gsd/gsd-plan-phase.md` with YAML frontmatter, 8 steps (parse phase, load details/config, check existing plans, check CONTEXT.md, run pipeline, verify results, update state/commit, present results), and behavioral guidelines. References `src/plan-phase.js` and `src/discuss-phase.js` for orchestration. Pipeline stages are config-gated.
  </done>
</task>

</tasks>

<verification>
1. `node -e "import { buildResearchPrompt, buildPlannerPrompt, buildCheckerPrompt, getExpectedPlanFiles, runPlanningPipeline } from './src/plan-phase.js'; console.log('OK');"` imports cleanly
2. All three prompt builders reference their respective agent definition files (not inline instructions)
3. `getExpectedPlanFiles` returns paths following `{paddedPhase}-TYPE.md` convention
4. `gsd-plan-phase.md` exists with frontmatter, 8 steps, and references to plan-phase.js
5. Pipeline is sequential: research -> plan -> check (not parallel)
6. Research and checker stages are gated by config.workflow.research and config.workflow.plan_check
7. Model orchestration is advisory logging only
</verification>

<success_criteria>
- `src/plan-phase.js` exports 5 functions with error-return pattern
- Sequential pipeline correctly handles: research(optional) -> plan(required) -> check(optional)
- Prompt builders reference agent definition files by path
- `workflows/gsd/gsd-plan-phase.md` is a complete Cline workflow with 8 steps
- Config toggles gate research and plan-check agent stages
- Model orchestration is implemented as advisory logging (satisfies AGT-06 intent)
</success_criteria>

<output>
After completion, create `.planning/phases/06-planning-workflow/06-02-SUMMARY.md`
</output>
