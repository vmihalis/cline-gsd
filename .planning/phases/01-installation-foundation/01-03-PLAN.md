---
phase: 01-installation-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/installer.js
  - workflows/gsd/health.md
  - bin/install.js
  - CHANGELOG.md
autonomous: false

must_haves:
  truths:
    - "User can run npx cline-gsd and workflows are copied to ~/.cline/commands/gsd/"
    - "health.md workflow file exists after installation"
    - "User can run /gsd:health in Cline and see installation status"
    - "Installer shows changelog after update"
    - "Partial failures clean up created files"
  artifacts:
    - path: "src/installer.js"
      provides: "Core installation logic"
      exports: ["install", "rollback"]
      min_lines: 50
    - path: "workflows/gsd/health.md"
      provides: "Health check workflow"
      contains: "/gsd:health"
    - path: "CHANGELOG.md"
      provides: "Version history"
      contains: "## [1.0.0]"
  key_links:
    - from: "bin/install.js"
      to: "src/installer.js"
      via: "import"
      pattern: "import.*from.*installer"
    - from: "src/installer.js"
      to: "workflows/gsd/health.md"
      via: "file copy"
      pattern: "copyFile|copyWorkflows"
---

<objective>
Implement the core installation logic that copies workflow files and create the /gsd:health workflow.

Purpose: Complete the installer so users can actually install Cline-GSD and verify it works
Output: Fully functional npx installer with health check workflow
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/01-installation-foundation/01-CONTEXT.md
@.planning/phases/01-installation-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check workflow</name>
  <files>workflows/gsd/health.md</files>
  <action>
Create workflows/gsd/health.md - the first Cline-GSD workflow:

1. Add YAML frontmatter:
   ```yaml
   ---
   description: Verify Cline-GSD installation status
   ---
   ```

2. Add workflow content:
   ```markdown
   # /gsd:health - Installation Health Check

   Check that Cline-GSD is properly installed and ready to use.

   ## Verification Steps

   1. **Check workflow files exist**
      - Look for ~/.cline/commands/gsd/ directory
      - List all .md workflow files present
      - Report count of installed workflows

   2. **Verify Cline CLI**
      - Run `cline --version` via Bash tool
      - Report version or note if not found

   3. **Check VERSION file**
      - Read ~/.cline/commands/gsd/VERSION if exists
      - Report Cline-GSD version

   4. **Validate workflow syntax**
      - Parse YAML frontmatter in each workflow
      - Report any syntax errors found

   ## Output Format

   Present results as a checklist:

   ```
   Cline-GSD Health Check
   ----------------------
   [checkmark] Workflows installed (N files)
   [checkmark] Cline CLI found (version X.Y.Z)
   [checkmark] Cline-GSD version 1.0.0
   [checkmark] Workflow syntax valid

   Status: Ready to use!
   ```

   Or if issues found:
   ```
   [X] Issue description
       Suggestion: how to fix
   ```

   ## Next Steps

   If all checks pass, suggest: "Try /gsd:help to see available commands"
   If issues found, provide specific fix instructions.
   ```

This workflow will be executed BY Cline when user types /gsd:health.
  </action>
  <verify>File exists at workflows/gsd/health.md and contains YAML frontmatter with description</verify>
  <done>workflows/gsd/health.md exists with verification steps and output format</done>
</task>

<task type="auto">
  <name>Task 2: Create core installer module</name>
  <files>src/installer.js</files>
  <action>
Create src/installer.js with the core installation logic:

1. Imports:
   ```javascript
   import fs from 'node:fs/promises';
   import path from 'node:path';
   import { fileURLToPath } from 'node:url';
   import { getClineConfigDir, getGsdCommandsDir } from './platform.js';
   import { success, error, warn, info, cyan } from './output.js';
   ```

2. Get package directory:
   ```javascript
   const __dirname = path.dirname(fileURLToPath(import.meta.url));
   const pkgRoot = path.join(__dirname, '..');
   ```

3. Track created paths for rollback:
   ```javascript
   const createdPaths = [];
   function trackCreated(p) { createdPaths.push(p); }
   ```

4. Export async `rollback()`:
   - Iterate createdPaths in reverse
   - Remove each path with fs.rm({ recursive: true, force: true })
   - Best effort cleanup (catch errors silently)

5. Export async `copyWorkflows(destDir, verbose = false)`:
   - Get source from path.join(pkgRoot, 'workflows', 'gsd')
   - Create destDir with fs.mkdir({ recursive: true })
   - Track destDir for rollback
   - Read all .md files from source
   - Copy each file to destDir
   - If verbose, log each file copied
   - Return count of files copied

6. Export async `writeVersion(destDir)`:
   - Read version from package.json
   - Write VERSION file to destDir
   - Track the file for rollback

7. Export async `install(options = {})`:
   - options: { verbose: false, force: false }
   - Get destDir from getGsdCommandsDir()
   - If destDir exists and not force: remove it first (clean install per CONTEXT.md)
   - Call copyWorkflows(destDir, options.verbose)
   - Call writeVersion(destDir)
   - Return { success: true, filesInstalled: count, location: destDir }

8. Error handling:
   - Wrap install in try/catch
   - On EACCES: friendly permission error message
   - On any error: call rollback(), then re-throw
   - Per CONTEXT.md: partial failures should clean up

Reference 01-RESEARCH.md "Copy Workflow Files" and "Atomic Rollback on Failure" patterns.
  </action>
  <verify>Import the module and call install() - should copy workflows to ~/.cline/commands/gsd/</verify>
  <done>src/installer.js exports install, rollback, copyWorkflows functions</done>
</task>

<task type="auto">
  <name>Task 3: Wire installer and add changelog display</name>
  <files>bin/install.js, CHANGELOG.md</files>
  <action>
Part A: Create CHANGELOG.md at project root:
```markdown
# Changelog

All notable changes to Cline-GSD will be documented in this file.

## [1.0.0] - 2026-02-05

### Added
- Initial release of Cline-GSD
- `npx cline-gsd` installer with platform detection
- `/gsd:health` workflow for installation verification
- Cross-platform support (Mac, Windows, Linux)
- Cline CLI detection with helpful warnings
- Colorful terminal output with progress spinners
```

Part B: Update bin/install.js to complete the installation flow:

1. Import installer:
   ```javascript
   import { install, rollback } from '../src/installer.js';
   import fs from 'node:fs/promises';
   ```

2. After the Cline check and target directory display, add:

   Step 4: Copy workflows
   ```javascript
   spinner.start('Copying workflows...');
   try {
     const result = await install({ verbose: args.verbose, force: args.force });
     spinner.succeed(`Installed ${result.filesInstalled} workflow(s)`);
   } catch (err) {
     spinner.fail('Installation failed');
     if (err.code === 'EACCES') {
       error('Permission denied. Try running with elevated privileges or check directory permissions.');
     } else {
       error(err.message);
     }
     process.exit(1);
   }
   ```

3. Add changelog display function:
   ```javascript
   async function showChangelog() {
     try {
       const changelogPath = path.join(pkgRoot, 'CHANGELOG.md');
       const content = await fs.readFile(changelogPath, 'utf8');
       // Extract latest version section
       const match = content.match(/^## \[[\d.]+\].*?\n([\s\S]*?)(?=\n## |$)/m);
       if (match) {
         console.log('\n' + cyan('--- What\'s New ---'));
         console.log(match[1].trim());
         console.log(cyan('------------------') + '\n');
       }
     } catch {
       // Changelog not found, skip silently
     }
   }
   ```

4. After successful install, show changelog:
   ```javascript
   await showChangelog();
   ```

5. Final success message:
   ```javascript
   success('Installation complete!');
   info(`Run ${cyan('/gsd:health')} in Cline to verify.`);
   ```

6. Parse args.verbose and args.force from command line (update parseArgs function)
  </action>
  <verify>Run `node bin/install.js` and verify workflows are copied, changelog is shown, success message displayed</verify>
  <done>Full installation flow works: detect, check, copy, display changelog, success message</done>
</task>

</tasks>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Cline-GSD installer with workflow installation and health check</what-built>
  <how-to-verify>
    1. Run `node bin/install.js` from project root
       - Should show: platform detection, Cline CLI check, workflow copy, changelog, success
    2. Check ~/.cline/commands/gsd/ exists and contains:
       - health.md (the workflow file)
       - VERSION (contains "1.0.0")
    3. If Cline CLI is installed, open Cline and run `/gsd:health`
       - Should show health check output with checkmarks
    4. Test error handling: `chmod 000 ~/.cline/commands/gsd && node bin/install.js --force`
       - Should show permission error and clean up
       - Then: `chmod 755 ~/.cline/commands/gsd` to restore
  </how-to-verify>
  <resume-signal>Type "approved" if installation works correctly, or describe issues</resume-signal>
</checkpoint>

<verification>
1. `node bin/install.js` completes without errors
2. `ls ~/.cline/commands/gsd/` shows health.md and VERSION
3. `cat ~/.cline/commands/gsd/VERSION` shows 1.0.0
4. Changelog section displayed after install
5. `/gsd:health` works in Cline (if CLI available)
</verification>

<success_criteria>
- Full installation flow completes successfully
- Workflow files copied to correct location
- VERSION file written
- Changelog displayed after install
- Permission errors handled gracefully with rollback
- Health check workflow functional in Cline
</success_criteria>

<output>
After completion, create `.planning/phases/01-installation-foundation/01-03-SUMMARY.md`
</output>
