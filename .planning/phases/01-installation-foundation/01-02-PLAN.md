---
phase: 01-installation-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/platform.js
  - src/cline-check.js
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "getPlatform() returns 'mac', 'windows', 'linux', or 'unknown'"
    - "checkClineCli() returns object with installed boolean and version"
    - "Installer shows platform detection step"
    - "Installer shows Cline CLI check with warning if not found"
  artifacts:
    - path: "src/platform.js"
      provides: "Platform detection"
      exports: ["getPlatform", "getHomeDir", "getClineConfigDir"]
    - path: "src/cline-check.js"
      provides: "Cline CLI verification"
      exports: ["checkClineCli", "getClineVersion"]
  key_links:
    - from: "bin/install.js"
      to: "src/platform.js"
      via: "import"
      pattern: "import.*from.*platform"
    - from: "bin/install.js"
      to: "src/cline-check.js"
      via: "import"
      pattern: "import.*from.*cline-check"
    - from: "src/cline-check.js"
      to: "command-exists"
      via: "import"
      pattern: "import.*command-exists"
---

<objective>
Add platform detection and Cline CLI verification to the installer.

Purpose: Ensure installer works across Mac/Windows/Linux and warns users if Cline CLI isn't installed
Output: Platform-aware installer that detects and reports environment status
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/01-installation-foundation/01-CONTEXT.md
@.planning/phases/01-installation-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform detection module</name>
  <files>src/platform.js</files>
  <action>
Create src/platform.js with platform detection functions:

1. Import `os` from 'node:os' and `path` from 'node:path'

2. Export `getPlatform()`:
   - Use os.platform() to get platform
   - Return 'mac' for 'darwin', 'windows' for 'win32', 'linux' for 'linux'
   - Return 'unknown' for anything else

3. Export `getHomeDir()`:
   - Return os.homedir()

4. Export `getClineConfigDir()`:
   - Check CLINE_DIR environment variable first (allows override)
   - Default to path.join(os.homedir(), '.cline')
   - Return the Cline config directory path

5. Export `getGsdCommandsDir()`:
   - Return path.join(getClineConfigDir(), 'commands', 'gsd')

Reference 01-RESEARCH.md "Platform Detection" and "Platform-Aware Paths" patterns.
  </action>
  <verify>Run `node -e "import('./src/platform.js').then(m => console.log(m.getPlatform(), m.getClineConfigDir()))"` outputs platform and path</verify>
  <done>src/platform.js exports getPlatform, getHomeDir, getClineConfigDir, getGsdCommandsDir</done>
</task>

<task type="auto">
  <name>Task 2: Create Cline CLI verification module</name>
  <files>src/cline-check.js</files>
  <action>
Create src/cline-check.js to verify Cline CLI installation:

1. Import `commandExists` from 'command-exists' (default export)
2. Import `execSync` from 'node:child_process'

3. Export async `getClineVersion()`:
   - Try to run `cline --version` using execSync
   - Return the trimmed output
   - On error, return null

4. Export async `checkClineCli()`:
   - Use commandExists to check if 'cline' command exists
   - If exists, get version via getClineVersion()
   - Return { installed: true, version: string } on success
   - Return { installed: false, version: null } on failure

Handle errors gracefully - the check should never throw.

Reference 01-RESEARCH.md "Check Cline CLI Installed" pattern.
  </action>
  <verify>Run `node -e "import('./src/cline-check.js').then(async m => console.log(await m.checkClineCli()))"` outputs object with installed status</verify>
  <done>src/cline-check.js exports checkClineCli that returns {installed, version}</done>
</task>

<task type="auto">
  <name>Task 3: Wire platform and Cline check into installer</name>
  <files>bin/install.js</files>
  <action>
Update bin/install.js to use platform detection and Cline CLI check:

1. Import ora for spinners: `import ora from 'ora'`
2. Import { getPlatform, getClineConfigDir } from '../src/platform.js'
3. Import { checkClineCli } from '../src/cline-check.js'
4. Import { success, warn, info, cyan } from '../src/output.js'

5. After banner display (if not --help/--version), add installation steps:

   Step 1: Detect platform
   ```javascript
   const spinner = ora('Detecting platform...').start();
   const platform = getPlatform();
   spinner.succeed(`Platform: ${cyan(platform)}`);
   ```

   Step 2: Check Cline CLI
   ```javascript
   spinner.start('Checking for Cline CLI...');
   const clineStatus = await checkClineCli();
   if (clineStatus.installed) {
     spinner.succeed(`Cline CLI found (${cyan(clineStatus.version || 'version unknown')})`);
   } else {
     spinner.warn('Cline CLI not found');
     warn('Cline-GSD requires Cline CLI. Install it first:');
     info('  npm install -g @anthropics/cline');
     info('Continuing installation anyway...');
   }
   ```

   Step 3: Show target directory
   ```javascript
   const configDir = getClineConfigDir();
   info(`Install location: ${cyan(configDir)}`);
   ```

6. Add placeholder comment for next step: `// TODO: Copy workflow files (Plan 03)`

7. Make the main function async and handle top-level await

Per user decision in CONTEXT.md: Missing Cline CLI should warn and continue, not fail.
  </action>
  <verify>Run `node bin/install.js` shows platform detection, Cline check (with warning if not found), and install location</verify>
  <done>Installer detects platform, checks for Cline CLI, shows target directory</done>
</task>

</tasks>

<verification>
1. `node bin/install.js` displays platform (mac/windows/linux)
2. `node bin/install.js` shows Cline CLI status (found with version OR warning if not found)
3. `node bin/install.js` shows install location (~/.cline or CLINE_DIR if set)
4. `CLINE_DIR=/tmp/test node bin/install.js` shows /tmp/test as install location
5. No errors thrown regardless of Cline CLI status
</verification>

<success_criteria>
- Platform detection works on current system
- Cline CLI check returns correct installed status
- Warning shown (not error) when Cline CLI not found
- Installation continues after warning
- CLINE_DIR env var respected
</success_criteria>

<output>
After completion, create `.planning/phases/01-installation-foundation/01-02-SUMMARY.md`
</output>
